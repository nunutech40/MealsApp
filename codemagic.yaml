workflows:
  ios_ci:
    name: iOS CI (tanpa CocoaPods)
    max_build_duration: 60
    environment:
      xcode: latest

    triggering:
      events:
        - push
      branch_patterns:
        - pattern: main
          include: true
          source: true

    scripts:
      - name: Debug layout
        script: |
          echo "PWD=$(pwd)"
          ls -la
          echo "=== Cari workspace/project ==="
          git ls-files | grep -E '\.xcworkspace$|\.xcodeproj$' || true

      - name: Build for iOS Simulator (xcodebuild)
        script: |
          set -euo pipefail

          # Cari .xcworkspace dulu, kalau tidak ada gunakan .xcodeproj
          WORKSPACE_PATH="$(git ls-files | grep -E '\.xcworkspace$' | head -n1 || true)"
          PROJECT_PATH=""
          if [ -z "$WORKSPACE_PATH" ]; then
            PROJECT_PATH="$(git ls-files | grep -E '\.xcodeproj$' | head -n1 || true)"
          fi

          if [ -z "$WORKSPACE_PATH" ] && [ -z "$PROJECT_PATH" ]; then
            echo "‚ùå Tidak menemukan .xcworkspace maupun .xcodeproj di repo."
            exit 1
          fi

          SCHEME_NAME="MealsApp"

          echo "Workspace: ${WORKSPACE_PATH:-<none>}"
          echo "Project  : ${PROJECT_PATH:-<none>}"
          echo "Scheme   : $SCHEME_NAME"

          if [ -n "$WORKSPACE_PATH" ]; then
            xcodebuild \
              -workspace "$WORKSPACE_PATH" \
              -scheme "$SCHEME_NAME" \
              -sdk iphonesimulator \
              -destination 'platform=iOS Simulator,OS=latest,name=iPhone 16' \
              clean build | xcpretty
          else
            xcodebuild \
              -project "$PROJECT_PATH" \
              -scheme "$SCHEME_NAME" \
              -sdk iphonesimulator \
              -destination 'platform=iOS Simulator,OS=latest,name=iPhone 16' \
              clean build | xcpretty
          fi

    artifacts:
      - $HOME/Library/Developer/Xcode/DerivedData/**/Build/**/*.app
      - $HOME/Library/Logs/**/*
    publishing:
      email:
        recipients:
          - nunutech4.0@gmail.com
        notify:
          success: false
          failure: true
